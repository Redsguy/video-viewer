<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
  <title>YouTube Player</title>
  <link rel="apple-touch-icon" href="playlistMaker512.png">
  <link rel="manifest" href="manifest.json">
  <script src="sw.js" defer></script>
<style>
button, a {touch-action: manipulation;}
body { font-family: 'Segoe UI', sans-serif; background: #f4f4f8; margin: 0; padding: 2rem; display: flex; flex-direction: column; align-items: center; }
h1 { color: #333; margin-bottom: 1rem; }
.container { background: white; padding: 2rem; border-radius: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); max-width: 700px; width: 100%; position: relative; }
textarea { width: 100%; padding: 0.8rem; font-size: 1rem; margin-bottom: 1rem; border: 1px solid #ccc; border-radius: 6px; resize: vertical; height: 150px; box-sizing: border-box;}
button { background-color: #cc0000; color: white; padding: 0.6rem 1rem; border: none; border-radius: 6px; font-size: 1rem; cursor: pointer; margin: 0.3rem; transition: background-color 0.3s ease; }
button:hover { background-color: #e60000; }
.info-button, .playlist-button { position: absolute; top: 1rem; width: 28px; height: 28px; border-radius: 50%; color: white; font-weight: bold; border: none; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; transition: background-color 0.3s ease; }
.info-button { right: 1rem; background-color: #0078d7; }
.info-button:hover { background-color: #005fa3; }
.playlist-button { right: 4rem; background-color: #555; }
.playlist-button:hover { background-color: #333; }
.video-container { margin-top: 2rem; position: relative; width: 100%; padding-bottom: 56.25%; height: 0; }
.video-container iframe { position: absolute; width: 100%; height: 100%; border: none; }
.playlist-builder { margin-top: 2rem; position: relative; }
ul { list-style-type: none; padding: 0; margin-top: 0.5rem; }
li { background: #eee; padding: 0.4rem 0.6rem; border-radius: 6px; margin: 0.3rem 0; font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; overflow: hidden; position: relative; }
.thumbnail { width: 80px; height: 60px; object-fit: cover; border-radius: 4px; flex-shrink: 0; transition: transform 0.2s ease, box-shadow 0.2s ease; }
.thumbnail:hover { transform: scale(1.05); box-shadow: 0 0 6px rgba(0,0,0,0.2); }
.video-info { display: flex; align-items: center; gap: 0.8rem; flex-grow: 1; overflow: hidden; text-decoration: none; color: #333; }
.video-title { font-weight: 500; font-size: 0.95rem; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; flex-grow: 1; max-width: calc(100% - 150px); }
.video-info:hover .video-title { text-decoration: underline; }
.toggle-buttons { display: flex; justify-content: flex-start; gap: 0.8rem; margin-top: 1rem; flex-wrap: nowrap; }
.active { background-color: #008000; }
#video-controls { display: none; text-align: center; margin-top: 1rem; }
#video-counter { margin: 0 1rem; font-weight: bold; }
.overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index:1000; }
.info-popup, .playlist-popup { background:white; padding:1.5rem 2rem; border-radius:10px; max-width:700px; width:90%; position:relative; box-shadow:0 10px 25px rgba(0,0,0,0.3); animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
.close-popup { position:absolute; top:10px; right:10px; background:none; border:none; font-size:18px; cursor:pointer; color:#888; transition:color 0.2s; }
.close-popup:hover { color:#000; }
.delete-btn { background:none; border:none; color:#cc0000; font-weight:bold; cursor:pointer; font-size:18px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; position:absolute; top:50%; right:10px; transform:translateY(-50%); transition:color 0.2s; }
.delete-btn:hover { color:#e60000; }

.playlist-grid {
  display: grid;
  grid-auto-flow: row; 
  grid-template-rows: none; 
  gap: 12px;
  align-items: start;
  max-height: 80vh; 
  overflow-y: auto;  
}

.arrow-btn { background:#0078d7; border:none; font-weight:bold; cursor:pointer; font-size:16px; width:36px; height:36px; display:flex; align-items:center; justify-content:center; margin:1px 0; color:white; }
.arrow-container { display:flex; flex-direction:column; margin-right:6px; }
#progress-indicator { margin-top:0.5rem; font-size:0.9rem; color:#333; min-height:1.2rem; transition: color 0.3s ease; }
#search-input { width: 100%; padding: 0.5rem; margin-top: 0.8rem; border-radius: 6px; border: 1px solid #ccc; box-sizing: border-box;}
.playlist-popup button span { color: black; font-weight: 500; text-align: left; }
</style>
</head>
<body>
<h1>YouTube Player</h1>
<div class="container">
  <button class="playlist-button" onclick="openPlaylistMenu()">â‰¡</button>
  <button class="info-button" onclick="openInfo()">i</button>

  <div id="video" class="video-container" style="display:none;"></div>
  <div id="video-controls">
    <span id="video-counter">0 / 0</span>
  </div>

  <div class="playlist-builder">
    <textarea id="video-url" placeholder="Paste YouTube URLs here...

Use '---' to separate playlists.

You can name a playlist by writing text before the first link."></textarea>
    <button onclick="addToPlaylist()">Add to Playlist</button>
    <div id="progress-indicator"></div>
    <div class="toggle-buttons">
      <button id="loopBtn" onclick="toggleLoop()">Loop: Off</button>
      <button onclick="shufflePlaylist()">Shuffle</button>
      <button onclick="startPlaylist()">Build Playlist</button>
    </div>
    <input type="text" id="search-input" placeholder="Search playlist...">
    <ul id="playlist"></ul>
  </div>
</div>
<!-- Info Popup -->
<div class="overlay" id="infoOverlay">
  <div class="info-popup">
    <button class="close-popup" onclick="closeInfo()">âœ–</button>
    <h2>How to Build a Playlist</h2>
    <ul>
      <li>Paste YouTube URLs into the box and click <strong>"Add to Playlist"</strong>.</li>
      <li>Separate playlists with a line of <strong>---</strong>.</li>
      <li>Add a name before the first link to name your playlist.</li>
      <li>Click <strong>"Shuffle"</strong> to randomize, or <strong>"Build Playlist"</strong> to play.</li>
      <li>Use the <strong>â‰¡</strong> menu to load, download, or switch playlists.</li>
    </ul>
  </div>
</div>

<!-- Playlist Menu -->
<div class="overlay" id="playlistOverlay">
  <div class="playlist-popup">
    <button class="close-popup" onclick="closePlaylistMenu()">âœ–</button>
    <h2>Playlist Menu</h2>
    <div class="toggle-buttons">
      <button onclick="downloadPlaylist()">Download</button>
      <input type="file" id="loadPlaylistFile" style="display:none" onchange="loadPlaylist(event)">
      <button onclick="document.getElementById('loadPlaylistFile').click()">Load</button>
      <button onclick="showPlaylistChooser()">Switch Playlist</button>
    </div>
  </div>
</div>

<script>
let playlists = JSON.parse(localStorage.getItem("playlists") || "[]");
const videoTitles = JSON.parse(localStorage.getItem("videoTitles") || "{}");
  
function savePlaylists() {
  localStorage.setItem("playlists", JSON.stringify(playlists));
}

const videoIds = [];
const dummyVideoId = "dQw4w9WgXcQ";
const addDummy = true;
let loop = false;

let currentPlaylistIndex = 0;

function openInfo() { document.getElementById('infoOverlay').style.display = 'flex'; }
function closeInfo() { document.getElementById('infoOverlay').style.display = 'none'; }
function openPlaylistMenu() { document.getElementById('playlistOverlay').style.display = 'flex'; }
function closePlaylistMenu() { document.getElementById('playlistOverlay').style.display = 'none'; }

function toggleLoop() {
  loop = !loop;
  document.getElementById('loopBtn').textContent = `Loop: ${loop ? 'On' : 'Off'}`;
}

async function fetchTitle(videoId) {
  try {
    const res = await fetch(
      `https://www.youtube.com/oembed?url=https://www.youtube.com/watch?v=${videoId}&format=json`
    );
    const data = await res.json();

    videoTitles[videoId] = data.title;
    localStorage.setItem("videoTitles", JSON.stringify(videoTitles)); // ðŸ’¾ cache
    renderPlaylist();

    return data.title;
  } catch {
    return videoId;
  }
}

async function addToPlaylist() {
  const text = document.getElementById("video-url").value.trim();
  if (!text) return;

  const indicator = document.getElementById("progress-indicator");

  const hasMultiple = text.includes('---');

  if (!hasMultiple) {
    const lines = text.split("\n").map(l => l.trim()).filter(Boolean);
    let added = 0;

    for (const line of lines) {
      const match = line.match(/(?:v=|youtu\.be\/)([\w-]{11})/);
      if (match) {
        const vid = match[1];
        videoIds.push(vid);
        added++;
        if (!videoTitles[vid]) videoTitles[vid] = await fetchTitle(vid);
      }
    }

    if (added === 0) {
      indicator.textContent = "No valid videos found.";
    } else {
      indicator.textContent = `Added ${added} video(s) to playlist.`;
      renderPlaylist();
    }

    document.getElementById("video-url").value = "";
    return; 
  }


  const groups = text.split(/\n-{3,}\n?/);
  let playlistsAdded = 0;

  for (const group of groups) {
    const lines = group.split("\n").map(l => l.trim()).filter(Boolean);

    let groupName = "";
    const groupIds = [];

    for (const line of lines) {
      const match = line.match(/(?:v=|youtu\.be\/)([\w-]{11})/);
      if (match) {
        const vid = match[1];
        groupIds.push(vid);
        if (!videoTitles[vid]) videoTitles[vid] = await fetchTitle(vid);
      } else if (!groupIds.length && line.length > 0) {
        groupName = line; 
      }
    }

      if (groupIds.length > 0) {
     playlists.push({ name: groupName || null, ids: groupIds });
     savePlaylists();
     playlistsAdded++;
   }

  }

  if (playlistsAdded === 0) {
    indicator.textContent = "No valid playlists found.";
    return;
  }

  indicator.textContent = `Added ${playlistsAdded} playlist(s).`;

  showPlaylistChooser();

  document.getElementById("video-url").value = "";
}

function loadPlaylistGroup(index) {
  currentPlaylistIndex = index;
  videoIds.length = 0;
  videoIds.push(...playlists[index].ids);
  renderPlaylist();
}

function showPlaylistChooser() {
  const overlay = document.createElement("div");
  overlay.className = "overlay";
  overlay.style.display = "flex";

  const popup = document.createElement("div");
  popup.className = "playlist-popup";
  popup.innerHTML = `<button class="close-popup">âœ–</button><h2>Select a Playlist</h2>`;

  const grid = document.createElement("div");
  grid.className = "playlist-grid";

  playlists.forEach((group, i) => {
    const firstId = group.ids[0];
    const title = group.name || videoTitles[firstId] || "Untitled Playlist";
    const thumb = `https://img.youtube.com/vi/${firstId}/default.jpg`;

    const container = document.createElement("div");
    container.style.position = "relative";
    container.style.display = "flex";
    container.style.alignItems = "center";
    container.style.background = "#f9f9f9";
    container.style.border = "1px solid #ccc";
    container.style.borderRadius = "6px";
    container.style.padding = "0.5rem";

    const btn = document.createElement("button");
    btn.style.display = "flex";
    btn.style.alignItems = "center";
    btn.style.gap = "0.8rem";
    btn.style.width = "100%";
    btn.style.background = "transparent";
    btn.style.border = "none";
    btn.innerHTML = `
      <img src="${thumb}" width="80" height="60" style="border-radius:4px;object-fit:cover;">
      <span style="color:black;">${title}</span>
    `;
    btn.onclick = () => {
      loadPlaylistGroup(i);
      document.body.removeChild(overlay);
    };

    const del = document.createElement("button");
    del.textContent = "âœ–";
    del.className = "delete-btn";
    del.onclick = (e) => {
      e.stopPropagation();
      playlists.splice(i, 1);
      savePlaylists();
      document.body.removeChild(overlay);
      showPlaylistChooser();
    };

    container.appendChild(btn);
    container.appendChild(del);
    grid.appendChild(container);
  });

  popup.appendChild(grid);

  const playAllBtn = document.createElement("button");
  playAllBtn.textContent = "Play All";
  playAllBtn.style.backgroundColor = "#cc0000";
  playAllBtn.style.color = "white";
  playAllBtn.style.padding = "0.6rem 1rem";
  playAllBtn.style.borderRadius = "6px";
  playAllBtn.style.marginTop = "1rem";
  playAllBtn.onclick = () => {
    
    const allVideos = playlists.flatMap(group => group.ids);

    const uniqueVideos = [...new Set(allVideos)];
    
    videoIds.length = 0;
    videoIds.push(...uniqueVideos);

    renderPlaylist();
    startPlaylist();
    
    document.body.removeChild(overlay);
  };

  popup.appendChild(playAllBtn);

  popup.querySelector(".close-popup").onclick = () => document.body.removeChild(overlay);
  overlay.appendChild(popup);
  document.body.appendChild(overlay);
}

function renderPlaylist() {
  const ul = document.getElementById("playlist");
  ul.innerHTML = "";

  videoIds.forEach((id, index) => {
    const li = document.createElement("li");

    const arrowDiv = document.createElement("div");
    arrowDiv.className = "arrow-container";

    const up = document.createElement("button");
    up.textContent = "â–²";
    up.className = "arrow-btn";
    up.onclick = () => {
      if (index > 0) {
        [videoIds[index - 1], videoIds[index]] = [videoIds[index], videoIds[index - 1]];
        renderPlaylist();
      }
    };

    const down = document.createElement("button");
    down.textContent = "â–¼";
    down.className = "arrow-btn";
    down.onclick = () => {
      if (index < videoIds.length - 1) {
        [videoIds[index + 1], videoIds[index]] = [videoIds[index], videoIds[index + 1]];
        renderPlaylist();
      }
    };

    arrowDiv.appendChild(up);
    arrowDiv.appendChild(down);
    li.appendChild(arrowDiv);

    const a = document.createElement("a");
    a.href = `https://www.youtube.com/watch?v=${id}`;
    a.target = "_blank";
    a.className = "video-info";

    const img = document.createElement("img");
    img.src = `https://img.youtube.com/vi/${id}/default.jpg`;
    img.className = "thumbnail";

    const span = document.createElement("span");
    span.textContent = videoTitles[id] || `Video: ${id}`;
    span.className = "video-title";

    a.appendChild(img);
    a.appendChild(span);
    li.appendChild(a);

    const del = document.createElement("button");
    del.textContent = "âœ–";
    del.className = "delete-btn";
    del.onclick = () => {
  videoIds.splice(index, 1);
  renderPlaylist();
};

    li.appendChild(del);
    ul.appendChild(li);
  });
}

function startPlaylist() {
  if (videoIds.length === 0) return alert("Add videos first!");

  const playlistToPlay = addDummy ? [dummyVideoId, ...videoIds] : [...videoIds];

  const first = playlistToPlay[0];
  const rest = playlistToPlay.slice(1).join(",");

  const videoDiv = document.getElementById("video");
  videoDiv.style.display = "block";

  const iframe = document.createElement("iframe");
  iframe.src = `https://www.youtube.com/embed/${first}?autoplay=1&playlist=${rest}&loop=${loop ? 1 : 0}`;
  iframe.allow = "autoplay; encrypted-media";
  iframe.allowFullscreen = true;

  videoDiv.innerHTML = "";
  videoDiv.appendChild(iframe);

  document.getElementById("video-controls").style.display = "block";
  document.getElementById("video-counter").textContent = `1 / ${playlistToPlay.length - 1}`;
}

function shufflePlaylist() {
  for (let i = videoIds.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [videoIds[i], videoIds[j]] = [videoIds[j], videoIds[i]];
  }
  renderPlaylist();
}

function downloadPlaylist() {
  if (videoIds.length === 0) {
    alert("No videos to download");
    return;
  }
  const blob = new Blob([videoIds.join("\n")], { type: "text/plain" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "playlist.txt";
  a.click();
}

function loadPlaylist(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = e => {
    const lines = e.target.result.split("\n").map(l => l.trim()).filter(Boolean);
    videoIds.length = 0;
    lines.forEach(id => videoIds.push(id));
    renderPlaylist();
  };
  reader.readAsText(file);
}

document.getElementById("search-input").addEventListener("input", e => {
  const val = e.target.value.toLowerCase();
  document.querySelectorAll("#playlist li").forEach(li => {
    const title = li.querySelector(".video-title").textContent.toLowerCase();
    li.style.display = title.includes(val) ? "" : "none";
  });
});
</script>

</body>
</html>

